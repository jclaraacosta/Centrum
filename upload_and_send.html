<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enviar JSON al collector (prueba)</title>
  <style>
    body{ font-family: system-ui, -apple-system, Roboto, Arial; padding:24px; background:#f6f8fb; color:#0b1220 }
    .card{ background:white; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(10,20,40,.06); max-width:820px; margin:0 auto }
    label{ display:block; margin-bottom:8px; font-weight:700 }
    input[type=file]{ display:block; margin-bottom:12px }
    textarea{ width:100%; min-height:220px; margin-top:8px; border:1px solid #e6e9ef; border-radius:8px; padding:10px; font-family:monospace; font-size:13px }
    .row{ display:flex; gap:8px; margin-top:12px }
    button{ padding:10px 12px; border-radius:8px; border:0; cursor:pointer }
    .primary{ background:#0b79ff; color:white }
    .secondary{ background:#eef2ff }
    .muted{ color:#64748b; font-size:13px }
    .send-overlay{ position:fixed; left:0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:9999; }
    .send-card{ display:flex; gap:12px; align-items:center; background:white; padding:16px 18px; border-radius:10px; color:#0b1220 }
    .spinner{ width:28px; height:28px; border-radius:50%; border:4px solid #eef2ff; border-top-color:#0b79ff; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform: rotate(360deg) } }
  </style>
</head>
<body>
  <div class="card">
    <h2>Enviar JSON al collector (Google Apps Script)</h2>
    <p class="muted">Carga un archivo JSON con la estructura de respuestas y envíalo al servicio. Se intentará por <strong>fetch</strong> (form-urlencoded). Si falla por CORS, se hará un <strong>POST</strong> mediante formulario en una nueva pestaña (fallback).</p>

    <label for="file">Selecciona archivo JSON</label>
    <input id="file" type="file" accept="application/json" />

    <label>Contenido (vista previa)</label>
    <textarea id="preview" placeholder="El contenido del JSON aparecerá aquí" readonly></textarea>

    <div class="row">
      <button id="btnSend" class="primary">Enviar al collector</button>
      <button id="btnOpen" class="secondary">Abrir JSON en nueva pestaña</button>
    </div>

    <hr style="margin:18px 0" />
    <div class="muted">
      <strong>ATENCIÓN:</strong> Reemplaza el valor de <code>COLLECTOR_URL</code> en este archivo si necesitas apuntar a otro Web App. Asegúrate que la Web App esté desplegada como "Anyone, even anonymous".
    </div>
  </div>

  <div id="overlay" class="send-overlay" style="display:none">
    <div class="send-card">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div id="ovTitle" style="font-weight:700">Enviando…</div>
        <div id="ovText" class="muted">Por favor espera</div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG
    const COLLECTOR_URL = "https://script.google.com/macros/s/AKfycbzD0AqqVPg--yOUyEouQypupPvwlcEO8aftdf570Y29o3q7YxgW9Vs6ISRsTJ1ODkjG/exec";
    const COLLECTOR_TOKEN = ""; // opcional

    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');
    const btnSend = document.getElementById('btnSend');
    const btnOpen = document.getElementById('btnOpen');
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ovTitle');
    const ovText = document.getElementById('ovText');

    let loadedJSON = null;

    function showOverlay(title, text){ overlay.style.display = 'flex'; ovTitle.textContent = title; ovText.textContent = text; }
    function hideOverlay(){ overlay.style.display = 'none'; }

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        // pretty print
        const obj = JSON.parse(txt);
        loadedJSON = obj;
        preview.value = JSON.stringify(obj, null, 2);
      }catch(err){
        loadedJSON = null;
        preview.value = 'Archivo inválido: ' + String(err);
      }
    });

    btnOpen.addEventListener('click', ()=>{
      if(!loadedJSON){ alert('Carga un JSON primero.'); return; }
      const w = window.open();
      w.document.write('<pre>' + JSON.stringify(loadedJSON, null, 2).replace(/</g,'&lt;') + '</pre>');
    });

    async function sendByFetch(payload){
      // Enviar como form-urlencoded para evitar preflight
      const form = new URLSearchParams();
      if(COLLECTOR_TOKEN) form.append('token', COLLECTOR_TOKEN);
      form.append('payload', JSON.stringify(payload));
      const resp = await fetch(COLLECTOR_URL, { method: 'POST', body: form });
      const ct = resp.headers.get('content-type') || '';
      let data = null;
      if(ct.includes('application/json')) data = await resp.json(); else { const t = await resp.text(); try{ data = JSON.parse(t); }catch{ data = { raw: t }; } }
      return { status: resp.status, ok: resp.ok, data };
    }

    function sendByForm(payload){
      // Fallback: submit a form to a new tab so the browser performs a normal POST (no XHR preflight)
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = COLLECTOR_URL;
      form.target = '_blank';
      form.style.display = 'none';

      const inPayload = document.createElement('input');
      inPayload.type = 'hidden';
      inPayload.name = 'payload';
      inPayload.value = JSON.stringify(payload);
      form.appendChild(inPayload);

      if(COLLECTOR_TOKEN){ const t = document.createElement('input'); t.type='hidden'; t.name='token'; t.value = COLLECTOR_TOKEN; form.appendChild(t); }

      document.body.appendChild(form);
      form.submit();
      setTimeout(()=> form.remove(), 1000);
    }

    btnSend.addEventListener('click', async ()=>{
      if(!loadedJSON){ alert('Carga un JSON válido antes de enviar.'); return; }
      const payload = loadedJSON;
      try{
        showOverlay('Enviando (fetch)…', 'Intentando enviar por fetch (form-urlencoded)');
        const r = await sendByFetch(payload);
        hideOverlay();
        if(r.ok){
          alert('Envío OK (fetch). Respuesta:\n' + JSON.stringify(r.data, null, 2));
          return;
        }
        // si la respuesta no es ok, mostrar y permitir fallback
        const retry = confirm('El envío por fetch devolvió un error o fue bloqueado. ¿Intentar con POST por formulario (abrirá una nueva pestaña)?');
        if(retry){ sendByForm(payload); }
      }catch(err){
        // probable CORS / network error -> fallback a form POST
        hideOverlay();
        const useForm = confirm('El envío con fetch falló (posible CORS). ¿Enviar mediante POST normal (abrirá una nueva pestaña)?');
        if(useForm){ sendByForm(payload); }
      }
    });
  </script>
</body>
</html>
