<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encuesta – BITA, ÉXITO y VALOR (Piloto)</title>
  <meta name="description" content="Cuestionario académico (pilotaje) sobre madurez BITA, éxito de proyectos de TD y valor de negocio." />
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#a9b2c3;
      --text:#e8eefc;
      --line:rgba(255,255,255,.10);
      --accent:#8bd5ff;
      --accent2:#7cf0c2;
      --danger:#ff7a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --max: 980px;
      --focus: 0 0 0 3px rgba(139,213,255,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(139,213,255,.20), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(124,240,194,.18), transparent 55%),
                  var(--bg);
      line-height:1.45;
    }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }
    .wrap{ max-width: var(--max); margin: 28px auto 80px; padding: 0 16px; }
    header{
      display:flex; flex-direction:column; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
    }
    header h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    header .sub{ color: var(--muted); font-size: 13px; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;}
    .pill{
      font-size:12px; color: var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.03);
    }
    .card{
      margin-top: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 8px; font-size:16px;}
    .card h3{ margin:16px 0 8px; font-size:14px; color: var(--accent2);}
    .muted{ color: var(--muted); }
    .notice{
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(139,213,255,.08);
      border: 1px solid rgba(139,213,255,.20);
      color: var(--text);
      margin: 10px 0 0;
    }
    .danger{
      background: rgba(255,122,122,.10);
      border: 1px solid rgba(255,122,122,.25);
    }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .row > * { flex: 1 1 auto; }
    label{ display:block; font-size: 13px; color: var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="email"], select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
      outline:none;
    }
    input[type="text"]:focus, input[type="email"]:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(139,213,255,.35);
    }
    .btnbar{
      display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px;
    }
    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(139,213,255,.22), rgba(139,213,255,.10));
      border:1px solid rgba(139,213,255,.28);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
    }
    button:hover{ filter: brightness(1.05); }
    button.secondary{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      font-weight: 600;
    }
    button.danger{
      background: rgba(255,122,122,.10);
      border:1px solid rgba(255,122,122,.25);
      color: var(--text);
    }
    .progress{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .progress > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(139,213,255,.85), rgba(124,240,194,.85));
    }
    details{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 10px;
    }
    details summary{
      cursor:pointer;
      list-style:none;
      font-weight: 700;
      color: var(--accent);
    }
    details summary::-webkit-details-marker{ display:none; }
    .qgroup{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }
    .qgroup:first-child{ border-top:0; padding-top:0; }
    .qtitle{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 8px;
    }
    .qtitle .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(255,255,255,.75);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .qtext{ font-size: 14px; margin: 0; }
    .likert{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
    }
    @media (min-width: 720px){
      .likert{ grid-template-columns: repeat(5, 1fr); }
    }
    .likert label{
      margin:0;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      color: var(--text);
      font-size: 13px;
      user-select:none;
    }
    .likert input{ accent-color: var(--accent2); }
    .likert label:hover{ border-color: rgba(139,213,255,.35); }
    .req{
      color: var(--danger);
      font-weight: 700;
      margin-left: 6px;
    }
    .foot{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
    }
    .stickybar{
      position: fixed;
      left: 0; right:0; bottom:0;
      background: rgba(11,18,32,.72);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      padding: 10px 12px;
    }
    .stickyinner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .stickyinner .mini{
      font-size: 12px; color: var(--muted);
    }
    .toast{
      position: fixed;
      top: 14px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width: min(720px, calc(100% - 24px));
      font-size: 13px;
    }
    .toast.show{ opacity:1; }
    .hidden{ display:none !important; }
    .right{ text-align:right; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width:720px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }
    .small{ font-size:12px; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="wrap">
    <header>
      <h1>Encuesta de Investigación: Incidencia moderadora del nivel de maduración del Business IT Aligment (BITA) entre la ejecución de proyectos de transformación digital y la generación de valor para el negocio</h1>
      <div class="sub">
        Versión de administración en español · Escala Likert 1–5 · BITA (estado actual) · ÉXITO y VALOR (últimos 24 meses).
      </div>
      <div class="pillrow">
        <span class="pill">Anónima</span>
        <span class="pill">Tiempo estimado: 8–12 min</span>
        <span class="pill">Unidad de análisis: organización</span>
      </div>

      <div class="progress" aria-label="Progreso del cuestionario">
        <div id="progressBar"></div>
      </div>
      <div class="sub"><span id="progressText">Progreso: 0%</span></div>
    </header>

    <!-- 1) CONSENTIMIENTO INFORMADO -->
    <section class="card" id="consent">
      <h2>1) Consentimiento informado</h2>
      <p class="muted">
        Este instrumento se utiliza con fines académicos para pilotear un cuestionario de investigación doctoral.
        La participación es voluntaria y puede retirarse en cualquier momento cerrando esta página. Las respuestas
        se registran de forma anónima (sin nombres ni correos). Si decides continuar, confirmas que has leído y entendido
        la información presentada.
      </p>

      <div class="notice">
        <strong>Proposito :</strong> Determinar cómo el nivel de maduración del BITA modera la relación entre la ejecución
         de proyectos de TD y la generación de valor para las empresas del sector servicios dentro de las regiones de Centroamérica y Suramérica.
      </div>
      <div class="notice">
        <strong>Confidencialidad:</strong> no se recolecta información personal identificable. Los resultados se analizarán
        de manera agregada. Si en tu implementación agregas almacenamiento en servidor, recuerda mantener los mismos
        principios de anonimato y minimización de datos.
      </div>
      <div class="notice">
        <strong>Contacto:</strong> Para resolver dudas y asuntos éticos, comunicarse con Juan Carlos Lara Acosta al correo jclaraacosta@gmail.com.
      </div>
      <div class="notice danger" style="margin-top:10px;">
        <strong>Importante (piloto):</strong> si detectas ambigüedades, términos confusos o ítems redundantes, al final puedes dejar
        comentarios para mejorar la claridad del cuestionario.
      </div>

      <div class="row" style="margin-top:14px;">
        <div style="flex:1 1 420px;">
          <label for="consentCheck">
            Confirmación de consentimiento <span class="req">*</span>
          </label>
          <div style="display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius:14px; background: rgba(0,0,0,.18);">
            <input type="checkbox" id="consentCheck" />
            <span>Acepto participar voluntariamente y entiendo el uso académico y anónimo de mis respuestas.</span>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnStart" type="button">Continuar</button>
        <button class="secondary" type="button" id="btnPrint">Imprimir / PDF</button>
      </div>

      <div class="foot">
        Tip: puedes usar <span class="kbd">Ctrl/Cmd + P</span> para guardar como PDF si lo necesitas.
      </div>
    </section>

    <!-- 2) DEFINICIONES PARA EVITAR CONFUSIONES -->
    <section class="card" id="definitions" style="display:none;">
      <h2>2) Definiciones y alcance (para evitar interpretaciones distintas)</h2>
      <p class="muted">
        Las siguientes definiciones buscan estandarizar el significado de términos clave. Por favor, responde el cuestionario
        usando estas definiciones como referencia.
      </p>

      <details open>
        <summary>Proyecto de Transformación Digital (TD)</summary>
        <p class="muted">
          Son iniciativas estratégicas que buscan alterar significativamente el modelo de creación de valor de la organización 
          mediante el uso de tecnologías digitales avanzadas (como IA, Cloud, IoT). A diferencia de los proyectos de TI tradicionales 
          —enfocados en la eficiencia operativa o la continuidad del soporte—, los proyectos de transformación digital redefinen 
          la estructura organizacional, los procesos y la cultura para responder a dinámicas de mercado disruptivas. 
          Para este cuestionario, responde pensando en tu proyecto de TD más reciente dentro de los últimos 24 meses
        </p>
      </details>

      <details open>
        <summary>Éxito de Proyectos de Transformación Digital (ÉXITO)</summary>
        <p class="muted">
          Logro integral del proyecto de TD considerando: (i) desempeño frente a alcance/tiempo/costo/calidad,
          (ii) satisfacción de usuarios y del equipo, (iii) beneficios organizacionales, y (iv) uso y adopción post-implementación.
          Para este cuestionario, responde pensando en tu proyecto de TD más reciente dentro de los últimos 24 meses.
        </p>
      </details>

      <details open>
        <summary>Valor de Negocio (VALOR)</summary>
        <p class="muted">
          Resultados de desempeño atribuibles a iniciativas de TD en cuatro perspectivas tipo Balanced Scorecard:
          financiera (FIN), cliente (CLI), procesos internos (PRO) y aprendizaje/crecimiento (APG).
          Responde considerando efectos en los últimos 24 meses.
        </p>
      </details>

      <details>
        <summary>Business–IT Alignment (BITA) – Madurez</summary>
        <p class="muted">
          Grado de alineación negocio–TI observado a través de prácticas organizacionales en seis dimensiones:
          comunicación (COM), competencias/medición de valor (CVM), gobernanza (GOB), asociación negocio–TI (PAR),
          alcance y arquitectura (AYA) y habilidades (HAB). Responde describiendo el estado actual de tu organización.
        </p>
      </details>

      <details>
        <summary>“Últimos 24 meses”</summary>
        <p class="muted">
          Periodo de referencia para ÉXITO y VALOR. Si tu organización tiene múltiples proyectos de TD, elige el más reciente
          y responde en función de ese proyecto y sus efectos en la operación.
        </p>
      </details>

      <div class="btnbar">
        <button id="btnToSurvey" type="button">Ir al cuestionario</button>
        <button class="secondary" type="button" id="btnBackToConsent">Volver</button>
      </div>
    </section>

    <!-- 3) CUESTIONARIO -->
    <section class="card" id="survey" style="display:none;">
      <h2>3) Cuestionario</h2>
      <p class="muted">
        Instrucciones: lee cada afirmación y marca tu grado de acuerdo. Escala Likert (1–5):
        1 = Totalmente en desacuerdo · 2 = En desacuerdo · 3 = Ni de acuerdo ni en desacuerdo · 4 = De acuerdo · 5 = Totalmente de acuerdo.
      </p>

      <div class="notice" style="margin-top:10px;">
        <strong>Ventana temporal:</strong> ÉXITO y VALOR (últimos 24 meses). BITA (estado actual de la organización).
      </div>

      <div id="questionnaireRoot"></div>

      <h3>Sección D. Datos de caracterización (marque una opción por ítem)</h3>
      <div class="grid2" id="demographics">
        <!-- rendered by JS -->
      </div>

      <h3>Comentarios finales (piloto)</h3>
      <p class="muted small">
        Si algún ítem fue ambiguo o si consideras que falta un indicador relevante, por favor indícalo. Esto mejora la calidad del instrumento.
      </p>
      <div>
        <label for="openComments">Comentarios / sugerencias</label>
        <input type="text" id="openComments" placeholder="Escribe aquí tus comentarios (opcional)" />
      </div>

      <div class="btnbar" style="margin-top:14px;">
        <button id="btnValidate" type="button">Validar respuestas</button>
        <button id="btnSubmit" type="button">Finalizar y generar archivo (JSON)</button>
        <button class="secondary" id="btnDownloadCSV" type="button">Descargar CSV</button>
        <button class="secondary" id="btnSaveLocal" type="button">Guardar borrador en este navegador</button>
        <button class="secondary" id="btnLoadLocal" type="button">Cargar borrador</button>
        <button class="danger" id="btnReset" type="button">Reiniciar</button>
      </div>

      <div class="foot">
        Nota: Este HTML no envía datos a ningún servidor. Para recolectar respuestas de un grupo, puedes:
        (a) incrustar este cuestionario en una plataforma que guarde resultados (Google Forms/Qualtrics/Typeform), o
        (b) agregar un endpoint propio (API) para recibir el JSON generado.
      </div>
    </section>

    <!-- 4) REFERENCIAS (enlaces) -->
    <section class="card" id="refs" style="display:none;">
      <h2>Referencias y enlaces base (para transparencia académica)</h2>
      <p class="muted">
        Estos enlaces son útiles si deseas documentar el sustento metodológico del enfoque (PLS-SEM, constructos de 2º orden, BSC).
        No son parte del cuestionario administrado, pero ayudan a mantener trazabilidad y rigor.
      </p>
      <ul class="muted">
        <li>PLS-SEM y constructos de segundo orden (libro): <a href="https://doi.org/10.1007/978-3-031-13005-9" target="_blank" rel="noopener">Hair et al., 2022</a></li>
        <li>Balanced Scorecard (concepto original): <a href="https://hbr.org/1992/01/the-balanced-scorecard-measures-that-drive-performance-2" target="_blank" rel="noopener">Kaplan & Norton (HBR)</a></li>
        <li>Alineamiento negocio–TI (fundamentos): <a href="https://misq.umn.edu/aligning-business-and-it-strategies.html" target="_blank" rel="noopener">Henderson & Venkatraman (MISQ)</a></li>
      </ul>
    </section>

  </div>

  <div class="stickybar">
    <div class="stickyinner">
      <div class="mini">
        Estado: <span id="statusText">Esperando consentimiento</span> · Ítems respondidos: <span id="answeredCount">0</span>/<span id="totalCount">0</span>
      </div>
      <div class="btnbar" style="margin:0;">
        <button class="secondary" id="btnJumpTop" type="button">Ir arriba</button>
        <button class="secondary" id="btnJumpSurvey" type="button">Ir al cuestionario</button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     *  CONFIGURACIÓN DEL CUESTIONARIO (Apéndice B)
     ******************************************************************/
    const LIKERT = [
      { value: 1, label: "1" },
      { value: 2, label: "2" },
      { value: 3, label: "3" },
      { value: 4, label: "4" },
      { value: 5, label: "5" },
    ];

    // Estructura: Sección -> Sub-sección (dimensión) -> ítems
    const SURVEY_SCHEMA = [
      {
        sectionId: "BITA",
        title: "Sección A. Madurez de Business–IT Alignment (BITA)",
        instruction: "Consigna: indique su grado de acuerdo sobre el estado actual de su organización.",
        window: "Estado actual",
        groups: [
          {
            groupId: "COM",
            title: "A1. Comunicación (COM)",
            items: [
              { code: "BITA_COM_1", text: "La alta dirección y TI comparten un lenguaje de negocio común al discutir iniciativas tecnológicas." },
              { code: "BITA_COM_2", text: "Los objetivos de TI se comunican con claridad a las áreas de negocio." },
              { code: "BITA_COM_3", text: "Los líderes de negocio comprenden las capacidades y limitaciones de TI." },
              { code: "BITA_COM_4", text: "Existen canales regulares y bidireccionales para resolver dudas entre negocio y TI." },
            ],
          },
          {
            groupId: "CVM",
            title: "A2. Competencias y medición de valor (CVM)",
            items: [
              { code: "BITA_CVM_1", text: "Los beneficios esperados de TI se estiman con métricas previamente definidas." },
              { code: "BITA_CVM_2", text: "Se monitorean KPIs para evaluar el valor aportado por iniciativas de TI." },
              { code: "BITA_CVM_3", text: "Los casos de negocio incluyen supuestos y riesgos explícitos." },
              { code: "BITA_CVM_4", text: "Existe retroalimentación sistemática para capturar beneficios realizados post-implementación." },
            ],
          },
          {
            groupId: "GOB",
            title: "A3. Gobernanza (GOB)",
            items: [
              { code: "BITA_GOB_1", text: "Existe un comité de priorización negocio–TI con roles definidos." },
              { code: "BITA_GOB_2", text: "Las decisiones de inversión en TI siguen un proceso transparente." },
              { code: "BITA_GOB_3", text: "Las políticas y estándares de TI están alineados con la estrategia y regulación." },
              { code: "BITA_GOB_4", text: "Las responsabilidades de negocio y TI en proyectos están claramente asignadas." },
            ],
          },
          {
            groupId: "PAR",
            title: "A4. Asociación negocio–TI (PAR)",
            items: [
              { code: "BITA_PAR_1", text: "TI participa desde etapas tempranas en decisiones estratégicas del negocio." },
              { code: "BITA_PAR_2", text: "Las áreas de negocio co-lideran junto con TI las iniciativas digitales." },
              { code: "BITA_PAR_3", text: "Se comparten objetivos y métricas comunes entre negocio y TI." },
              { code: "BITA_PAR_4", text: "Los acuerdos de nivel de servicio (SLA) se negocian y monitorean conjuntamente." },
            ],
          },
          {
            groupId: "AYA",
            title: "A5. Alcance y arquitectura (AYA)",
            items: [
              { code: "BITA_AYA_1", text: "Contamos con una arquitectura tecnológica estandarizada y documentada." },
              { code: "BITA_AYA_2", text: "Los sistemas clave están integrados con intercambio de datos confiable." },
              { code: "BITA_AYA_3", text: "Las soluciones de TI son escalables para soportar el crecimiento del negocio." },
              { code: "BITA_AYA_4", text: "Se reutilizan componentes y servicios tecnológicos para acelerar las entregas." },
            ],
          },
          {
            groupId: "HAB",
            title: "A6. Habilidades (HAB)",
            items: [
              { code: "BITA_HAB_1", text: "Existe un plan de desarrollo de habilidades digitales para el personal." },
              { code: "BITA_HAB_2", text: "La organización gestiona el cambio asociado a nuevas soluciones tecnológicas." },
              { code: "BITA_HAB_3", text: "El equipo de TI posee competencias actualizadas en tecnologías relevantes." },
              { code: "BITA_HAB_4", text: "Se promueve una cultura colaborativa y orientada a datos." },
            ],
          },
        ],
      },
      {
        sectionId: "EXITO",
        title: "Sección B. Éxito de Proyectos de Transformación Digital (EXITO)",
        instruction: "Consigna: piense en su proyecto de TD más reciente (últimos 24 meses).",
        window: "Últimos 24 meses",
        groups: [
          {
            groupId: "OBJ",
            title: "B1. Cumplimiento de objetivos (OBJ)",
            items: [
              { code: "EXITO_OBJ_1", text: "El proyecto cumplió el alcance previsto." },
              { code: "EXITO_OBJ_2", text: "Se entregó dentro del presupuesto aprobado." },
              { code: "EXITO_OBJ_3", text: "Se ejecutó conforme al cronograma comprometido." },
              { code: "EXITO_OBJ_4", text: "La calidad de los entregables fue consistente con los estándares definidos." },
            ],
          },
          {
            groupId: "USU",
            title: "B2. Satisfacción de usuarios (USU)",
            items: [
              { code: "EXITO_USU_1", text: "Los usuarios finales están satisfechos con la solución implementada." },
              { code: "EXITO_USU_2", text: "El sistema facilita el trabajo diario de los usuarios." },
              { code: "EXITO_USU_3", text: "La experiencia de uso es intuitiva y consistente." },
              { code: "EXITO_USU_4", text: "Recomendaríamos la solución a otras áreas de la organización." },
            ],
          },
          {
            groupId: "EQU",
            title: "B3. Satisfacción del equipo (EQU)",
            items: [
              { code: "EXITO_EQU_1", text: "El equipo percibió apoyo gerencial adecuado durante el proyecto." },
              { code: "EXITO_EQU_2", text: "La colaboración entre miembros del equipo fue efectiva." },
              { code: "EXITO_EQU_3", text: "La carga de trabajo fue manejable en las etapas críticas." },
              { code: "EXITO_EQU_4", text: "El proyecto fortaleció las capacidades y aprendizajes del equipo." },
            ],
          },
          {
            groupId: "BEN",
            title: "B4. Beneficios organizacionales (BEN)",
            items: [
              { code: "EXITO_BEN_1", text: "Se redujeron los tiempos de ciclo en procesos clave." },
              { code: "EXITO_BEN_2", text: "Disminuyeron errores o retrabajos en las operaciones." },
              { code: "EXITO_BEN_3", text: "Aumentó la productividad del área involucrada." },
              { code: "EXITO_BEN_4", text: "Se mejoró el cumplimiento regulatorio o de auditoría." },
            ],
          },
          {
            groupId: "USO",
            title: "B5. Uso y adopción (USO)",
            items: [
              { code: "EXITO_USO_1", text: "La solución es utilizada frecuentemente por los usuarios previstos." },
              { code: "EXITO_USO_2", text: "Existen prácticas de uso y soporte institucionalizadas." },
              { code: "EXITO_USO_3", text: "La adopción se mantuvo o incrementó tras el go-live." },
              { code: "EXITO_USO_4", text: "Las funcionalidades clave son aprovechadas en su totalidad." },
            ],
          },
        ],
      },
      {
        sectionId: "VALOR",
        title: "Sección C. Valor de Negocio (VALOR)",
        instruction: "Consigna: responda sobre los efectos observados (últimos 24 meses).",
        window: "Últimos 24 meses",
        groups: [
          {
            groupId: "FIN",
            title: "C1. Perspectiva financiera (FIN)",
            items: [
              { code: "VALOR_FIN_1", text: "Mejoró el margen operativo del área/proceso impactado." },
              { code: "VALOR_FIN_2", text: "Se redujeron costos operativos relevantes." },
              { code: "VALOR_FIN_3", text: "Se generaron nuevos ingresos o fuentes de monetización." },
              { code: "VALOR_FIN_4", text: "Mejoró el retorno sobre la inversión en TI." },
            ],
          },
          {
            groupId: "CLI",
            title: "C2. Perspectiva del cliente (CLI)",
            items: [
              { code: "VALOR_CLI_1", text: "Aumentó la satisfacción del cliente/usuario externo." },
              { code: "VALOR_CLI_2", text: "Se redujeron los tiempos de atención o respuesta al cliente." },
              { code: "VALOR_CLI_3", text: "Se incrementó la retención o recompra de clientes." },
              { code: "VALOR_CLI_4", text: "Mejoró la experiencia omnicanal (consistencia entre canales)." },
            ],
          },
          {
            groupId: "PRO",
            title: "C3. Perspectiva de procesos internos (PRO)",
            items: [
              { code: "VALOR_PRO_1", text: "Se estandarizaron procesos críticos relacionados." },
              { code: "VALOR_PRO_2", text: "Mejoró la trazabilidad y el control de los procesos." },
              { code: "VALOR_PRO_3", text: "Se redujeron cuellos de botella operativos." },
              { code: "VALOR_PRO_4", text: "Se incrementó la calidad de los datos (completitud y exactitud)." },
            ],
          },
          {
            groupId: "APG",
            title: "C4. Perspectiva de aprendizaje y crecimiento (APG)",
            items: [
              { code: "VALOR_APG_1", text: "Se fortalecieron las capacidades analíticas y orientadas a datos." },
              { code: "VALOR_APG_2", text: "Aumentó la colaboración e intercambio de conocimiento entre áreas." },
              { code: "VALOR_APG_3", text: "Se implementaron prácticas de innovación continua." },
              { code: "VALOR_APG_4", text: "Mejoró la disponibilidad de talento con competencias digitales." },
            ],
          },
        ],
      },
    ];

    const DEMOGRAPHICS_SCHEMA = [
      {
        id: "pais",
        label: "País",
        type: "select",
        required: true,
        options: ["México","Colombia","Ecuador","Perú","Chile","Otro"],
      },
      {
        id: "sector",
        label: "Sector",
        type: "select",
        required: true,
        options: ["Banca","Seguros","Telecomunicaciones","Logística","Otros servicios"],
      },
      {
        id: "tamano",
        label: "Tamaño de la organización (empleados)",
        type: "select",
        required: true,
        options: ["<250","250–999","1,000–4,999","≥5,000"],
      },
      {
        id: "rol",
        label: "Rol del encuestado",
        type: "select",
        required: true,
        options: ["C-Level","Gerencia","Jefatura","Especialista/Analista","Otro"],
      },
      {
        id: "ant_org",
        label: "Antigüedad en la organización",
        type: "select",
        required: true,
        options: ["<1 año","1–3","4–6","7–10",">10"],
      },
      {
        id: "ant_cargo",
        label: "Antigüedad en el cargo",
        type: "select",
        required: true,
        options: ["<1 año","1–3","4–6","7–10",">10"],
      },
      {
        id: "tipo_td",
        label: "Tipo de proyecto TD evaluado",
        type: "select",
        required: true,
        options: ["Front-office","Back-office","Analítica/IA","Automatización (RPA/IDP)","Integración/ERP/CRM","Otro"],
      },
      {
        id: "complejidad",
        label: "Complejidad percibida del proyecto",
        type: "select",
        required: true,
        options: ["Baja","Media","Alta"],
      },
      {
        id: "duracion",
        label: "Duración del proyecto",
        type: "select",
        required: true,
        options: ["<6 meses","6–12 meses","13–24 meses",">24 meses"],
      },
      {
        id: "presupuesto",
        label: "Presupuesto aproximado",
        type: "select",
        required: true,
        options: ["<US$250k","US$250k–US$1M","US$1M–US$5M",">US$5M"],
      },
    ];

    /******************************************************************
     *  RENDER
     ******************************************************************/
    const elConsent = document.getElementById("consent");
    const elDefinitions = document.getElementById("definitions");
    const elSurvey = document.getElementById("survey");
    const elRefs = document.getElementById("refs");
    const statusText = document.getElementById("statusText");
    const questionnaireRoot = document.getElementById("questionnaireRoot");
    const elDemographics = document.getElementById("demographics");

    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const answeredCountEl = document.getElementById("answeredCount");
    const totalCountEl = document.getElementById("totalCount");

    const toast = document.getElementById("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function scrollToId(id){
      const el = document.getElementById(id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // Compute total number of likert items
    function getAllItemCodes(){
      const codes = [];
      SURVEY_SCHEMA.forEach(sec=>{
        sec.groups.forEach(g=>{
          g.items.forEach(it=>codes.push(it.code));
        });
      });
      return codes;
    }
    const ALL_CODES = getAllItemCodes();
    const TOTAL_LIKERT = ALL_CODES.length;

    // Responses holder (in-memory)
    const state = {
      consent: false,
      responses: {},     // itemCode -> 1..5
      demographics: {},  // fieldId -> value
      comments: ""
    };

    totalCountEl.textContent = String(TOTAL_LIKERT);

    function renderLikertItem(item){
      const wrapper = document.createElement("div");
      wrapper.className = "qgroup";
      wrapper.dataset.code = item.code;

      const top = document.createElement("div");
      top.className = "qtitle";

      const p = document.createElement("p");
      p.className = "qtext";
      p.innerHTML = `${item.text} <span class="req" title="Requerido">*</span>`;

      const code = document.createElement("div");
      code.className = "code";
      code.textContent = item.code;

      top.appendChild(p);
      top.appendChild(code);

      const likert = document.createElement("div");
      likert.className = "likert";
      LIKERT.forEach(opt=>{
        const lab = document.createElement("label");
        const input = document.createElement("input");
        input.type = "radio";
        input.name = item.code;
        input.value = String(opt.value);
        input.addEventListener("change", ()=>{
          state.responses[item.code] = Number(opt.value);
          updateProgress();
        });
        lab.appendChild(input);
        const span = document.createElement("span");
        span.textContent = opt.label;
        lab.appendChild(span);
        likert.appendChild(lab);
      });

      wrapper.appendChild(top);
      wrapper.appendChild(likert);
      return wrapper;
    }

    function renderSection(sec){
      const container = document.createElement("div");
      container.className = "card";
      container.style.marginTop = "14px";
      container.style.boxShadow = "none";
      container.style.background = "rgba(255,255,255,.03)";

      const h = document.createElement("h3");
      h.textContent = sec.title;
      container.appendChild(h);

      const meta = document.createElement("p");
      meta.className = "muted small";
      meta.textContent = `${sec.instruction} Ventana temporal: ${sec.window}.`;
      container.appendChild(meta);

      sec.groups.forEach(g=>{
        const gTitle = document.createElement("h3");
        gTitle.textContent = g.title;
        gTitle.style.color = "var(--accent2)";
        gTitle.style.marginTop = "14px";
        container.appendChild(gTitle);

        g.items.forEach(it=>{
          container.appendChild(renderLikertItem(it));
        });
      });

      return container;
    }

    function renderQuestionnaire(){
      questionnaireRoot.innerHTML = "";
      SURVEY_SCHEMA.forEach(sec=>{
        questionnaireRoot.appendChild(renderSection(sec));
      });
    }

    function renderDemographics(){
      elDemographics.innerHTML = "";
      DEMOGRAPHICS_SCHEMA.forEach(field=>{
        const box = document.createElement("div");
        const lab = document.createElement("label");
        lab.setAttribute("for", field.id);
        lab.innerHTML = `${field.label}${field.required ? ' <span class="req">*</span>' : ''}`;
        box.appendChild(lab);

        let input;
        if(field.type === "select"){
          input = document.createElement("select");
          input.id = field.id;
          const empty = document.createElement("option");
          empty.value = "";
          empty.textContent = "Seleccione…";
          input.appendChild(empty);

          field.options.forEach(opt=>{
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            input.appendChild(o);
          });
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.id = field.id;
        }

        input.addEventListener("change", ()=>{
          state.demographics[field.id] = input.value;
        });

        box.appendChild(input);
        elDemographics.appendChild(box);
      });
    }

    function updateProgress(){
      const answered = Object.keys(state.responses).length;
      answeredCountEl.textContent = String(answered);

      const pct = Math.round((answered / TOTAL_LIKERT) * 100);
      progressBar.style.width = `${pct}%`;
      progressText.textContent = `Progreso: ${pct}%`;
      if(!state.consent){
        statusText.textContent = "Esperando consentimiento";
      } else {
        statusText.textContent = elSurvey.style.display === "none" ? "Leyendo definiciones" : "Respondiendo cuestionario";
      }
    }

    function validateAll(){
      const missingLikert = ALL_CODES.filter(c => !(c in state.responses));
      const missingDemo = DEMOGRAPHICS_SCHEMA
        .filter(f => f.required)
        .filter(f => !state.demographics[f.id] || String(state.demographics[f.id]).trim()==="");

      const problems = [];
      if(!state.consent) problems.push("Falta aceptar el consentimiento informado.");
      if(missingLikert.length) problems.push(`Faltan ${missingLikert.length} respuestas Likert (ej.: ${missingLikert.slice(0,3).join(", ")}${missingLikert.length>3?"…":""}).`);
      if(missingDemo.length) problems.push(`Faltan ${missingDemo.length} campos de caracterización (ej.: ${missingDemo.slice(0,2).map(x=>x.label).join(", ")}${missingDemo.length>2?"…":""}).`);

      if(problems.length){
        showToast("Validación: hay campos pendientes.");
        return { ok:false, problems, missingLikert, missingDemo };
      }
      showToast("Validación: todo completo ✅");
      return { ok:true, problems:[] };
    }

    function download(filename, text, mime="application/json"){
      const blob = new Blob([text], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function toCSV(obj){
      // Aplanar a una sola fila
      const cols = [];
      const row = [];
      // Metadata
      cols.push("timestamp_iso");
      row.push(new Date().toISOString());

      cols.push("consent");
      row.push(state.consent ? "1" : "0");

      // demographics
      DEMOGRAPHICS_SCHEMA.forEach(f=>{
        cols.push(f.id);
        row.push((state.demographics[f.id] ?? "").toString().replaceAll('"','""'));
      });

      // Likert items
      ALL_CODES.forEach(code=>{
        cols.push(code);
        row.push((state.responses[code] ?? "").toString());
      });

      cols.push("comments");
      row.push((state.comments ?? "").toString().replaceAll('"','""'));

      const esc = (v)=> `"${String(v)}"`;
      return `${cols.map(esc).join(",")}\n${row.map(esc).join(",")}\n`;
    }

    function saveLocal(){
      const payload = buildPayload();
      localStorage.setItem("bita_pilot_draft", JSON.stringify(payload));
      showToast("Borrador guardado en este navegador ✅");
    }

    function loadLocal(){
      const raw = localStorage.getItem("bita_pilot_draft");
      if(!raw){
        showToast("No hay borrador guardado.");
        return;
      }
      try{
        const payload = JSON.parse(raw);
        hydrateFromPayload(payload);
        showToast("Borrador cargado ✅");
      }catch(e){
        showToast("No se pudo cargar el borrador (formato inválido).");
      }
    }

    function hydrateFromPayload(payload){
      // consent
      state.consent = !!payload.consent;
      document.getElementById("consentCheck").checked = state.consent;

      // responses
      state.responses = payload.responses || {};
      // set radio buttons
      ALL_CODES.forEach(code=>{
        const v = state.responses[code];
        if(v){
          const radio = document.querySelector(`input[name="${code}"][value="${v}"]`);
          if(radio) radio.checked = true;
        }
      });

      // demographics
      state.demographics = payload.demographics || {};
      DEMOGRAPHICS_SCHEMA.forEach(f=>{
        const el = document.getElementById(f.id);
        if(el && (state.demographics[f.id] != null)) el.value = state.demographics[f.id];
      });

      // comments
      state.comments = payload.comments || "";
      document.getElementById("openComments").value = state.comments;

      updateProgress();
    }

    function buildPayload(){
      return {
        meta: {
          instrument: "BITA-EXITO-VALOR (Piloto)",
          language: "es",
          likert_scale: "1-5",
          temporal_window: {
            BITA: "estado actual",
            EXITO_VALOR: "últimos 24 meses"
          },
          timestamp_iso: new Date().toISOString(),
          note: "Este HTML no envía datos a servidor. El participante puede descargar sus respuestas (JSON/CSV)."
        },
        consent: state.consent,
        demographics: state.demographics,
        responses: state.responses,
        comments: state.comments
      };
    }

    /******************************************************************
     *  UI FLOW (Consent -> Definitions -> Survey)
     ******************************************************************/
    document.getElementById("btnStart").addEventListener("click", ()=>{
      const checked = document.getElementById("consentCheck").checked;
      if(!checked){
        showToast("Debes aceptar el consentimiento para continuar.");
        return;
      }
      state.consent = true;
      elConsent.style.display = "none";
      elDefinitions.style.display = "block";
      elSurvey.style.display = "none";
      elRefs.style.display = "none";
      updateProgress();
      scrollToId("definitions");
    });

    document.getElementById("btnBackToConsent").addEventListener("click", ()=>{
      elConsent.style.display = "block";
      elDefinitions.style.display = "none";
      elSurvey.style.display = "none";
      elRefs.style.display = "none";
      updateProgress();
      scrollToId("consent");
    });

    document.getElementById("btnToSurvey").addEventListener("click", ()=>{
      elConsent.style.display = "none";
      elDefinitions.style.display = "none";
      elSurvey.style.display = "block";
      elRefs.style.display = "block";
      updateProgress();
      scrollToId("survey");
    });

    document.getElementById("btnJumpTop").addEventListener("click", ()=> scrollToId("consent"));
    document.getElementById("btnJumpSurvey").addEventListener("click", ()=>{
      if(elSurvey.style.display === "none"){
        showToast("Primero acepta el consentimiento y lee las definiciones.");
        return;
      }
      scrollToId("survey");
    });

    document.getElementById("btnPrint").addEventListener("click", ()=> window.print());

    // Survey actions
    document.getElementById("btnValidate").addEventListener("click", ()=>{
      const res = validateAll();
      if(!res.ok){
        alert("Pendientes:\n\n- " + res.problems.join("\n- "));
      }
    });

    document.getElementById("btnSubmit").addEventListener("click", ()=>{
      state.comments = document.getElementById("openComments").value || "";
      const res = validateAll();
      if(!res.ok){
        alert("Antes de finalizar, completa lo pendiente:\n\n- " + res.problems.join("\n- "));
        return;
      }
      const payload = buildPayload();
      download(`respuestas_bita_piloto_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.json`, JSON.stringify(payload, null, 2));
      showToast("Archivo JSON generado ✅");
    });

    document.getElementById("btnDownloadCSV").addEventListener("click", ()=>{
      state.comments = document.getElementById("openComments").value || "";
      const payload = buildPayload(); // just to ensure comments synced
      const csv = toCSV(payload);
      download(`respuestas_bita_piloto_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.csv`, csv, "text/csv");
      showToast("CSV generado ✅");
    });

    document.getElementById("btnSaveLocal").addEventListener("click", ()=>{
      state.comments = document.getElementById("openComments").value || "";
      saveLocal();
    });

    document.getElementById("btnLoadLocal").addEventListener("click", ()=>{
      loadLocal();
    });

    document.getElementById("btnReset").addEventListener("click", ()=>{
      if(!confirm("¿Seguro que deseas reiniciar y borrar todas las respuestas?")) return;
      state.responses = {};
      state.demographics = {};
      state.comments = "";
      document.querySelectorAll('input[type="radio"]').forEach(r=> r.checked = false);
      document.getElementById("openComments").value = "";
      DEMOGRAPHICS_SCHEMA.forEach(f=>{
        const el = document.getElementById(f.id);
        if(el) el.value = "";
      });
      updateProgress();
      showToast("Reiniciado.");
      scrollToId("survey");
    });

    // Progress tracking on load
    renderQuestionnaire();
    renderDemographics();
    updateProgress();

    // Keep demographics state in sync (on load default)
    DEMOGRAPHICS_SCHEMA.forEach(f=>{
      state.demographics[f.id] = "";
    });

    // Accessibility: keyboard hint
    document.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
        // prevent browser save dialog on some contexts
        e.preventDefault();
        state.comments = document.getElementById("openComments")?.value || state.comments;
        saveLocal();
      }
    });
  </script>
</body>
</html>